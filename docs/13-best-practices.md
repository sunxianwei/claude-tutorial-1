# 13 - 最佳实践：从实战中总结

## 工程师的 5 大误区

### ❌ 误区 1：让 Claude 替代所有思考

```
错误做法:
claude-code . "帮我完整地实现这个系统"
→ 结果：AI 生成的代码可能不符合你的真实需求
```

```
正确做法:
1. 自己先理解需求、设计方案
2. 让 Claude Code 加速实现
3. 自己审查和完善
```

### ❌ 误区 2：过度依赖上下文

```
错误做法:
# 加载 50 GB 的代码库
claude-code . "优化项目"
```

```
正确做法:
# 选择性加载相关模块
claude-code ./src/performance-critical . "优化"
```

### ❌ 误区 3：忽视规范文件

```
错误做法:
# 没有 CLAUDE.md，每次都要重复说明规范
claude-code . "代码里加日志，使用 console.log"
claude-code . "代码里加日志，使用 log4j"
```

```
正确做法:
# 创建完整的 CLAUDE.md
# 一次配置，永久生效
# Claude 自动遵守规范
```

### ❌ 误区 4：不验证 Claude 的输出

```
错误做法:
claude-code . "优化数据库查询"
# 直接上生产
```

```
正确做法:
claude-code . "优化数据库查询"
npm test                    # 运行测试
npm run perf-test          # 性能测试
code review                # 人工审查
staging deploy             # 测试环境
production deploy          # 生产发布
```

### ❌ 误区 5：过度优化

```
错误做法:
# 花 2 天优化一个 5% 的性能改进
# 而这个模块只占系统 1% 的时间消耗
```

```
正确做法:
# 优先处理高频路径
# 使用 APM 工具识别真正的瓶颈
# 基于数据进行优化
```

## ✅ 最佳实践 Top 10

### 1. 创建完整的规则文件

```markdown
投入：30 分钟
收益：每次节省 5 分钟 × 100 次请求 = 500 分钟

CLAUDE.md 应该包含：
- 代码风格规范
- 项目结构约定
- 工程规范
- 团队的特殊需求
```

### 2. 优化 .claudeignore

```markdown
投入：10 分钟
收益：每次速度快 30-50%

应该忽略：
- node_modules/
- .git/
- build/
- 日志文件
- 临时文件
```

### 3. 分层项目规则

```markdown
投入：20 分钟
收益：规则灵活性 + 可维护性

结构：
.claude/
├── rules-base.md       # 基础规范
├── rules-frontend.md   # 前端特定
└── rules-backend.md    # 后端特定
```

### 4. 版本控制提交信息

```bash
投入：5 分钟配置
收益：完整的项目历史记录

做法：
# 让 Claude 自动生成规范的提交信息
claude-code . "完成功能，自动提交"
→ Claude 自动生成符合规范的提交信息
```

### 5. 使用 SubAgent 链

```bash
投入：理解流程
收益：自动化完整的工作流

示例：
codegen → testing → security → review → docs
```

### 6. 定期更新 MCP 配置

```markdown
投入：每月 1 小时
收益：获得最新工具和特性

检查项：
- [ ] MCP 服务是否有更新
- [ ] 新的 MCP 插件是否值得集成
- [ ] 性能是否需要优化
```

### 7. 建立代码模板库

```bash
投入：1-2 天
收益：新项目快速启动

项目模板：
- React + TypeScript
- Vue + TypeScript
- Spring Boot
- 微服务模板
```

### 8. 监控 Token 消耗

```markdown
投入：自动化
收益：成本控制 30-50%

做法：
- 记录每次请求的 token 数
- 分析哪些请求最费 token
- 优化上下文大小
```

### 9. 建立审查清单

```markdown
投入：30 分钟
收益：避免常见问题

清单示例：
□ 代码是否遵守规范
□ 测试覆盖率是否足够
□ 有没有安全问题
□ 性能是否可接受
□ 文档是否完整
```

### 10. 记录常见问题

```markdown
投入：持续累积
收益：问题解决速度快 80%

建立 FAQ：
Q: 如何优化 N+1 查询?
A: [具体步骤和示例]

Q: 如何处理并发冲突?
A: [具体步骤和示例]
```

## 工作流程建议

### 新功能开发的黄金流程

```
1️⃣ 需求确认 (15 min)
   - 理解功能需求
   - 列出验收标准
   - 确认设计

2️⃣ 架构设计 (30 min)
   - 模块划分
   - API 设计
   - 数据库设计

3️⃣ 编码实现 (2-3 h)
   - 后端 API
   - 数据库迁移
   - 前端页面

4️⃣ 测试验证 (1 h)
   - 单元测试
   - 集成测试
   - 功能测试

5️⃣ 代码审查 (30 min)
   - 规范检查
   - 安全审查
   - 性能检查

6️⃣ 上线部署 (30 min)
   - 文档更新
   - 部署准备
   - 灰度发布
```

## 团队协作建议

### 1. 统一规范

```bash
# 公司级规范
~/.claude/CLAUDE.md

# 项目级规范
project/.claude/CLAUDE.md

# 模块级规范
project/src/module/CLAUDE.md
```

### 2. 共享最佳实践

```markdown
建立知识库：
/docs/claude-code-guides/
├── 新手指南.md
├── 常见问题.md
├── 工作流程.md
├── 性能优化.md
└── 安全审查.md
```

### 3. 定期培训

```markdown
频率：每月 1 次
时长：1-2 小时

内容：
- Claude Code 新特性
- 最佳实践分享
- 案例分析
- Q&A
```

### 4. 建立评估体系

```markdown
评估指标：
- 代码审查通过率
- 测试覆盖率
- 缺陷率
- 开发速度
- 团队满意度
```

## 成本优化建议

### Token 消耗分析

```
一个月的典型成本：
- 新项目启动：$100-200
- 日常功能开发：$30-50/天
- 代码审查和优化：$20-30/天
- 文档生成：$10-20/天

优化后可降低 50-70%
```

### 模型选择策略

```
Claude Opus 4.1       ← 复杂任务、系统设计
Claude Sonnet 4       ← 日常开发（推荐）⭐
Claude Haiku 4.5      ← 简单任务、成本优化
```

### 优化建议

```markdown
1. 使用适合的模型（不要都用 Opus）
2. 减小上下文窗口
3. 定期清理 .claudeignore
4. 使用缓存和记忆功能
5. 批量处理任务而非单个请求
```

## 常见场景的高效用法

### 场景 1：快速原型开发

```bash
# 目标：3 天内完成 MVP
claude-code --subagent=codegen \
  --context-window=small \
  --chain="codegen" \
  . "快速实现核心功能"
```

### 场景 2：遗留系统维护

```bash
# 目标：最小化对现有代码的理解
claude-code . "基于现有代码，修复 bug XXX"

# Claude 会自动：
# 1. 查找相关代码
# 2. 理解上下文
# 3. 进行最小化修改
# 4. 运行测试验证
```

### 场景 3：大规模重构

```bash
# 目标：分步进行，降低风险

# 第一步：分析
claude-code . "分析重构影响范围"

# 第二步：制定计划
claude-code . "制定详细的重构计划"

# 第三步：分阶段实施
for step in 1..5; do
  claude-code --subagent=refactor . "执行第 $step 步"
  npm test
done
```

## 度量和持续改进

### 关键指标

```markdown
开发效率指标：
- 平均功能完成时间
- 代码审查通过率
- 缺陷修复速度

质量指标：
- 代码覆盖率
- 缺陷率
- 性能达标率

成本指标：
- Token 消耗量
- 人工审查时间
- 总开发成本
```

### 定期回顾

```markdown
频率：每周/月/季度

检查项：
□ 工作流程是否还有改进空间
□ 规范是否需要更新
□ 新工具/特性是否值得采用
□ 团队满意度如何
□ 成本控制是否达到目标
```

---

**时间提示：** 本章作为持续参考，定期复习 ⏱️

**下一步：** 应用这些最佳实践到你的项目中！
